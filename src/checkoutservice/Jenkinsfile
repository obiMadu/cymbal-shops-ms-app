pipeline {
    agent {
        label 'ubuntu'
    }

    environment {
        SERVICE_NAME = 'checkoutservice'
        JFROG_CR_USERNAME = 'cymbal-shops'
        JFROG_CR_IMAGE = '${JFROG_CR_USERNAME}/${SERVICE_NAME}'
        SONARQUBE_PROJECT_ID = 'cymbal-checkoutservice'
        MANIFESTS_GIT_SERVER = ''
        MANIFESTS_REPO_URL = ''
        MANIFESTS_REPO_BRANCH = '*/main'
        MANIFESTS_REPO_USER_EMAIL = 'jenkins-ci@gitea.obi.ninja'
        DEPLOYMENT_DIR = 'manifests/'
        DEPLOYMENT_FILENAME = 'checkoutservice-deployment.yaml'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv(installationName: 'SonarQube', credentialsId: 'sonarqube-token-90') {
                    script {
                        def directory = 'src/${SERVICE_NAME}'
                        def scannerHome = tool 'SonarQubeScanner'

                        dir(directory) {
                            sh "${scannerHome}/bin/sonar-scanner -Dsonar.projectKey=${SONARQUBE_PROJECT_ID}"
                        }
                    }
                }   
            }
        }

        stage('Code Quality Gate') {
            steps {
                waitForQualityGate abortPipeline: true
            }
        }

        stage('Build and Tag Image') {
            steps {
                script {
                    def directory = 'src/${SERVICE_NAME}'
                    dir(directory) {
                        // Built and Tag Image with Current Build No.
                        dockerImage = docker.build("${JFROG_CR_IMAGE}:v${currentBuild.number}")
                    }
                }
            }
        }

        stage('Scan with Trivy') {
            environment {
                TRIVY_DB_REPOSITORY = "public.ecr.aws/aquasecurity/trivy-db"
                TRIVY_JAVA_DB_REPOSITORY = "public.ecr.aws/aquasecurity/trivy-java-db"
            }
            steps {
                script {
                    // Run Trivy scan on the Docker image
                    trivyOutput = sh(
                        script: 'trivy image --exit-code 1 --severity HIGH,CRITICAL ${JFROG_CR_IMAGE}:v${currentBuild.number}',
                        returnStatus: true
                    )
                }
            }
        }

        stage('Image Quality Gate') {
            steps {
                script {
                    if (trivyOutput == 0) {
                        echo "Trivy scan passed. No HIGH or CRITICAL vulnerabilities found."
                    } else {
                        echo "Trivy scan failed. HIGH or CRITICAL vulnerabilities found."
                        echo "Gate Skipped. Be sure to Enforce in a real Project."
                        // currentBuild.result = 'UNSTABLE'
                    }
                }  
            }
        }

        stage('Push Image to Jfrog CR') {
            steps {
                script {
                    docker.withRegistry('https://artifactory.obi.ninja', 'jfrog-cymbal-shops') {
                        docker.image("${JFROG_CR_IMAGE}:v${currentBuild.number}").push()
                        docker.image("${JFROG_CR_IMAGE}:v${currentBuild.number}").push("latest")
                    }
                }
            }
        }

        stage('Update Manifest and Create Pull Request') {
            steps {
                script {
                    // Checkout the specified Git repository
                    checkout([$class: 'GitSCM',
                            branches: [[name: '${MANIFESTS_REPO_BRANCH}']],
                            userRemoteConfigs: [[url: '${MANIFESTS_REPO_URL}']]])
                    
                    // Specify the directory, file, and new image name
                    def directory = '${DEPLOYMENT_DIR}'
                    def file = '${DEPLOYMENT_FILENAME}'
                    def imageName = '${JFROG_CR_IMAGE}:v${currentBuild.number}'
                    
                    // Generate a unique branch name
                    def branchName = "update-image-to-v${currentBuild.number}"
                    
                    // Use the dir step to change the current directory
                    dir(directory) {
                        // Create a new branch
                        sh "git checkout -b ${branchName}"
                        
                        // Run the sed command to update the image name
                        sh "sed -i 's/image: .*/image: ${imageName}/' ${file}"
                        
                        // Use the withCredentials step to provide the Git credentials
                        withCredentials([usernamePassword(credentialsId: 'gitea-jenkinsci-creds', usernameVariable: 'GITEA_USERNAME', passwordVariable: 'GITEA_PASSWORD')]) {
                            // Set the Git user email and name
                            sh 'git config --global user.email "${MANIFESTS_REPO_USER_EMAIL}"'
                            sh 'git config --global user.name "${GITEA_USERNAME}"'
                            
                            // Add the modified file to the Git staging area
                            sh 'git add ${file}'
                            
                            // Commit the changes with a message
                            sh 'git commit -m "feat($SERVICE_NAME): Update image to v${currentBuild.number}"'
                            
                            // Push the new branch to the remote repository
                            sh "git push https://${GITEA_USERNAME}:${GITEA_PASSWORD}@${MANIFESTS_REPO_URL} ${branchName}"
                            
                            // Create a pull request using the Gitea API
                            def apiUrl = "https://gitea.your-domain.com/api/v1/repos/your-username/your-repository/pulls"
                            def requestBody = """
                                {
                                    "title": "Update image name",
                                    "body": "Automatically updated the image name using Jenkins pipeline",
                                    "head": "${branchName}",
                                    "base": "main"
                                }
                            """
                            sh "curl -X POST -H 'Content-Type: application/json' -d '${requestBody}' -u ${GITEA_USERNAME}:${GITEA_PASSWORD} ${apiUrl}"
                        }
                    }
                }
    }
}


    }

    post {
        always {
            // Clean up the workspace after the build
            cleanWs()
        }
    }
}
